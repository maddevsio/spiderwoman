<html>
<head>
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.13/css/dataTables.bootstrap.min.css">
    <meta name="referrer" content="never">
    <script type="text/javascript" charset="utf8" src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
    <script type="text/javascript" charset="utf8" src="//cdn.datatables.net/plug-ins/1.10.13/dataRender/datetime.js"></script>
    <script>
        $(document).ready( function () {
            var dateQS = "";
            var newQS = "";
            var hostQS = "";
            if (qs('date') != null) {
                dateQS = qs('date');
            }
            if (qs('new') != null) {
                newQS = qs('new');
            }
            var apiUrl = '/all?date='+dateQS+'&new='+newQS
            if (qs('host') != null) {
                hostQS = qs('host');
                apiUrl = '/all-for-host?host='+hostQS
            }

            $('.date-'+dateQS).css('color', 'red');
            $('#table_id').DataTable({
                pageLength: 200,
                ajax: {
                    url: apiUrl,
                    dataSrc: ''
                },
                columns: [
                    { data: "Created" },
                    { data: "SourceHost" },
                    { data: "SourceHostType" },
                    { data: "ExternalHost" },
                    { data: "ExternalHostType" },
                    { data: "Count" },
                    { data: "ExternalLink" }
                ],
                columnDefs: [
                    {
                        targets: 0,
                        render: $.fn.dataTable.render.moment( '', 'Do MMM YYYY' )
                    },
                    {
                        targets: 3,
                        render: function ( data, type, row ) {
                            var info = '[<a href="?host=' + data + '">info</a>] '
                            var href = '<a target="blank" href="http://' + data + '">' + data + '</a>';
                            return info + href;
                        },
                    },
                    {
                      targets: 4,
                      render: function ( data, type, row ) {
                        var host = '"'+row.ExternalHost+'"';
                        var type = '"'+row.ExternalHostType+'"';
                        return "<span data-host='"+row.ExternalHost+"' id='type"+row.ID+"'>"+ data + "</span>" + " <button data-type='"+row.ExternalHostType+"' id='changeType"+row.ID+"' onClick='changeType("+row.ID + "," +host+","+type+")'>C</button>";
                      },
                    },
                    { sClass: "nwDate", aTargets: [ 0 ] }
                ],
                order: [[ 0, "desc" ]]
            });
        } );

        function changeType(id, hostName, hostType){
          var types = {{ .types }};
          var sel = document.createElement('select');
          sel.name = "host_type";
          sel.className = "changeType"
          sel.setAttribute("id", "changeTypeSel"+id);
          var fragment = document.createDocumentFragment();
          var empty_opt = document.createElement('option');
          empty_opt.innerHTML = "-";
          empty_opt.value = "";
          empty_opt.selected = true;
          fragment.appendChild(empty_opt);
          var selected_type = $('#changeType'+id).attr('data-type')
          types.forEach(function(type, index) {
              var opt = document.createElement('option');
              opt.innerHTML = type;
              opt.value = type;
              if (opt.value == selected_type) {
                opt.selected = true;
              }
              fragment.appendChild(opt);
          });
          sel.appendChild(fragment);
          $('#changeType'+id).hide();
          $('#type'+id).hide();
          $('#changeType'+id).after(sel);
          sel.addEventListener(
             'change',
             function() { updateType(id, hostName,this.value); },
             false
          );
        }

        function updateType(id, host_name, host_type){
          if (host_type) {
            $.post( "/types/update", {"host_type": host_type, "host_name": host_name }, function() {
              $('#changeTypeSel'+id).hide();
              $('#changeType'+id).show();
              $("span[data-host='"+host_name+"']").each(function(i, obj) {
                  $(this).text(host_type);
              });
              $('.'+host_name).text(host_type);
              $('#type'+id).show();
              $('#changeType'+id).attr("data-type", host_type);
            });
          } else {
            console.log('heloo')
            $('#changeTypeSel'+id).hide();
            $('#changeType'+id).show();
            $('#type'+id).show();
          }
        }

        function qs(key) {
            key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
            var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"));
            return match && decodeURIComponent(match[1].replace(/\+/g, " "));
        }
    </script>
    <style>
        .nwDate {
            white-space: nowrap;
        }
    </style>
</head>
<body style="padding: 15px 15px 15px 15px;">
<p style="text-align: right; font-size: small; padding:0; margin:0;">
    <a href="/types">Types</a> | Server status: {{ .status }}
</p>

{{if .dateQS}}
    <p style="text-align: right;"><a href="/xls/spiderwoman-{{.dateQS}}.xls">Скачать эксель за {{.dateQS}}</a></p>
{{end}}

<h1 style="text-align:center;">{{ .title }}</h1>
<div style="text-align: center; font-size: 10px;">
    <a href="/" class="date-">all</a>&nbsp;&nbsp;
    {{ range $date := .dates }}
        <a href="/?date={{ $date }}" class="date-{{ $date }}">{{ $date }}</a>:<a href="/?date={{ $date }}&new=1" class="date-{{ $date }}">new</a>
        &nbsp;|&nbsp;&nbsp;
    {{ end }}
</div>
<table id="table_id" class="table table-striped table-bordered" style="font-family:Arial; font-size:12px;">
    <thead>
    <tr>
        <th>Created</th>
        <th>SourceHost</th>
        <th>TypeSH</th>
        <th>ExternalHost</th>
        <th>TypeEH</th>
        <th>Count</th>
        <th>ExternalLink</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="nwDate">Created</td>
        <td>SourceHost</td>
        <td>TypeSH</td>
        <th>ExternalHost</th>
        <th>TypeEH</th>
        <th>Count</th>
        <th>ExternalLink</th>
    </tr>
    </tbody>
</table>
</body>
</html>
